services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.profiling
    ports:
      - "8080:8080"
    environment:
      - SCYLLA_URI=scylladb:9042
      - RUST_MIN_STACK=8388608
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      - forum-network
    depends_on:
      scylladb:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    # Enable privileged mode for profiling tools
    privileged: true
    # Mount additional volumes for profiling
    volumes:
      - ./profiling:/app/profiling
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    # Add capabilities for profiling
    cap_add:
      - SYS_ADMIN
      - SYS_PTRACE
      - IPC_LOCK
    ulimits:
      stack: 8388608
    restart: unless-stopped
    # Override kernel parameters for profiling
    sysctls:
      - kernel.perf_event_paranoid=-1

  # Database (same as before)
  scylladb:
    image: scylladb/scylla:latest
    container_name: scylla-profiling
    command: >
      --seeds=scylla-profiling
      --smp=1
      --memory=512M
      --overprovisioned=1
      --developer-mode=1
    environment:
      - SCYLLA_DEVELOPMENT=1
    volumes:
      - ./scylla-data-profiling:/var/lib/scylla
    ports:
      - "9042:9042"
      - "9160:9160"
      - "9180:9180"
      - "10000:10000"
    networks:
      - forum-network
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "cqlsh", "-e", "describe keyspaces"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  forum-network:
    driver: bridge

volumes:
  loki-data:
  grafana-data:
